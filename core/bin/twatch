#!/bin/bash

# twatch â€” open twitch chat and stream in sway + mpv (Wayland)
# Usage: twatch <twitch_channel_name>

WORKSPACE="3"
BROWSER="firefox"
PLAYER="mpv"

if [ -z "$1" ]; then
    echo "Usage: $0 <twitch_channel_name>"
    exit 1
fi

TWITCH_CHANNEL="$1"
TWITCH_URL="https://www.twitch.tv/$TWITCH_CHANNEL"

echo "Checking if $TWITCH_CHANNEL is live..."

# Check if stream is live
if ! streamlink --quiet --stream-url "$TWITCH_URL" best >/dev/null 2>&1; then
    echo "$TWITCH_CHANNEL is offline or unreachable."
    exit 1
fi

echo "$TWITCH_CHANNEL is live. Launching chat and stream..."

# Open Twitch chat on target workspace
swaymsg workspace "$WORKSPACE"
swaymsg exec "$BROWSER --new-window https://www.twitch.tv/popout/$TWITCH_CHANNEL/chat"

nohup streamlink \
    --player "$PLAYER" \
    --player-args="--gpu-context=wayland --force-window=yes" \
    "$TWITCH_URL" "1080p,best" \
    >/dev/null 2>&1 &
